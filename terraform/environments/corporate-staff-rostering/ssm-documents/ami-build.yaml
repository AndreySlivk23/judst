---
schemaVersion: "2.2"
description: "SSM Document to convert an Azure VM into an AWS AMI." 
parameters:
  InstanceId:
    type: "String"
    description: "ID of the MGN replicated Azure server"
  VolumeId:
    type: "String"
    description: "Root volume ID to be snapshotted"
  SnapshotName:
    type: "String"
    description: "Name of the resultant snapshot"
  AMIName:
    type: "String"
    description: "Name of the AMI being built"

mainSteps:
  - name: CreateSnapshot # rewrite this to use the pre-set tasks rather than call the doc
    action: aws:runDocument
    inputs: 
      documentType: SSMDocument
      documentPath: AWS-CreateSnapshot
      documentParameters:
        VolumeId: "{{ VolumeId }}"
        description: "{{ SnapshotName }}"
    onFailure: Abort # this needs to fail

  - name: getRootVolumeSpace
    action: aws:runPowerShellScript
    maxAttempts: 1
    inputs:
      runCommand:
        - |
          $rootVolume = Get-WmiObject -Query "SELECT * FROM Win32_LogicalDisk WHERE DeviceID = 'C:'"
          $availableSpaceGB = [math]::Round(($rootVolume.FreeSpace / 1GB), 2)
          $totalSpaceGB = [math]::Round(($rootVolume.Size / 1GB), 2) # good 
          $availablePercentage = [math]::Round((($availableSpaceGB / $totalSpaceGB) * 100), 2)
          Write-Output "Available space on the C drive is $availableSpaceGB GB, which is $availablePercentage% % of the total space"
          if ($availablePercentage% -lt 50) {
            Write-Output "Available disk space is less than 50%; stopping AMI build."
            Exit 1
          } else {
            Write-Output "Available disk space is more than 50%; Continuing with AMI build"
          }
    onFailure: Abort    

  - name: stopDiscoveryAgent
    action: aws:runPowerShellScript # run as admin
    inputs:
      runCommand:
        - |
          Stop-Service -Name 'AWSDiscoveryService' -ErrorAction SilentlyContinue

  - name: UninstallDiscoveryAgent
    action: aws:runPowerShellScript
    onFailure: Abort  
    inputs:
      runCommand:
        - |
          $output = cmd.exe /c "wmic product where name='AWS Discovery Agent' call uninstall"
          $outputRegex = "Return value = (\d+)"
          when ($output -match $outputRegex){
            $returnValue = [int]$matches[1] 
          }
          if ($returnValue -eq 0) {
            Write-Host "Uninstall of AWS Disovery Agent successful, proceeding..." 
          } else {
            Write-Error "Uninstall of AWS Discovery Agent unsuccessful, aborting..."
          }


  - name: InstallFirefoxBrowser
    action: aws:runPowerShellScript
    inputs:
      runCommand:
        - |
          # update invoke to use Start-BitsTransfer if slow
          Invoke-WebRequest -URI "https://download.mozilla.org/?product=firefox-esr-next-latest-ssl&os=win64&lang=en-GB" -OutFile "$ENV:TEMP\MozillaFirefox.exe"
          Invoke-Item "$ENV:TEMP\MozillaFirefox.exe"

  - name: InstallNmapTool 
    action: aws:runPowerShellScript
    inputs:
      runCommand:
        - |
          # update invoke to use Start-BitsTransfer if slow <<<< need this
          Invoke-WebRequest -URI "https://nmap.org/download" -OutFile "$ENV:TEMP\nmap.exe"
          Invoke-Item "$ENV:TEMP\nmap.exe"

  - name: checkADModulePresent
    action: aws:runPowerShellScript
    inputs: 
      runCommand:
        - |
          $module = Get-Module -ListAvailable -Name ActiveDirectory
          if (-not $module) {
            Write-Error "Active Directory module is not installed. Installing..." 
          }

  - name: InstallActiveDirectoryModule
    action: aws:runPowerShellScript
    inputs:
      runCommand:
        - |
          Install-WindowsFeature -Name "RSAT-AD-PowerShell" -IncludeAllSubFeature

  - name: InstallEC2LaunchV2
    action: aws:runPowerShellScript
    inputs: 
      runCommand:
        - |
          # update invoke to use Start-BitsTransfer if slow
          Invoke-WebRequest -URI https://s3.amazonaws.com/ec2-downloads-windows/SSM-Agent/EC2Launch/latest/install.ps1 -OutFile $env:TEMP\install.ps1         
          powershell -ExecutionPolicy Bypass -File $env:TEMP\install.ps1
  
  - name: verifyInstallation
    action: aws:runPowerShellScript
    inputs:
      runCommand:
        - |
          if (Get-Service -Name EC2Launch | Where-Object {$_.Status -eq 'Running'}) {
            Write-Output "EC2LaunchV2 driver installed and running successfully."
          } else {
            Write-Output "EC2LaunchV2 driver installation or service startup failed."
          }

  - name: stopInstance
    action: aws:runDocument
    inputs:
      documentName: SSMDocument
      documentPath: AWS-StopEC2Instance
      documentParameters:
        instanceID: "{{ InstanceId }}"

  - name: createImage
    action: aws:runDocument
    inputs:
      documentName: SSMDocument
      documentPath: AWS-CreateImage
      documentParameters:
        instanceID: "{{ InstanceId }}"
        imageName: "{{ AMIName }}"
    onFailure: Abort
 
  - name: outputImageId
    action: aws:runPowerShellScript
    inputs:
      runCommand:
        - |  
          Write-Output "Image ID: $ImageId"

  - name: waitForAMI
    action: aws:runPowerShellScript
    inputs:
      runCommand:
        - |
          $amiId = "{{ createAmi.Outputs.ImageId }}"
          $amiState = Get-EC2Image -ImageIds $amiId | Select-Object -ExpandProperty State
          while ($amiState -ne "available") {
             Write-Output "AMI is not available yet. Current state: $amiState"
             Start-Sleep -Seconds 60
             $amiState = Get-EC2Image -ImageIds $amiId | Select-Object -ExpandProperty State
          }
          Write-Output "AMI ($amiId) is now available."
      
  - name: startInstance
    action: aws:runDocument
    inputs:
      documentName: SSMDocument
      documentPath: AWS-StartEC2Instance
      documentParameters:
        instanceID: "{{ InstanceId }}"